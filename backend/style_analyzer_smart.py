# prompt_generator_FORMATTED.py - –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º

import json
import os
from datetime import datetime

class FormattedPromptGenerator:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º—Ç —Å –ß–ï–¢–ö–û–ô –°–¢–†–£–ö–¢–£–†–û–ô –∏ –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    def __init__(self, facts_file='data/facts_advanced.json'):
        self.facts_file = facts_file
        self.user_facts = self.load_facts()
    
    def load_facts(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —Ñ–∞–∫—Ç—ã –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        try:
            with open(self.facts_file, 'r', encoding='utf-8') as f:
                facts = json.load(f)
                print(f"‚úÖ –§–∞–∫—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ {self.facts_file}")
                return facts
        except FileNotFoundError:
            print(f"‚ö†Ô∏è {self.facts_file} –Ω–µ –Ω–∞–π–¥–µ–Ω!")
            return {}
    
    def generate_full_prompt(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ü–û–õ–ù–´–ô –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –ø—Ä–æ–º—Ç —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π"""
        
        facts = self.user_facts
        
        # ============================================================
        # 1. –û–°–ù–û–í–ù–ê–Ø –õ–ò–ß–ù–û–°–¢–¨
        # ============================================================
        personal = facts.get('personal', {})
        location = facts.get('location', {})
        
        full_name = personal.get('full_name', 'Andrew Wein')
        current_city = location.get('current_city', '–ú–æ—Å–∫–≤–∞')
        age = personal.get('age', '')
        
        section1 = f"–¢—ã {full_name}. –ñ–∏–≤–µ—à—å –≤ {current_city}."
        if age:
            section1 += f" –¢–µ–±–µ {age} –ª–µ—Ç."
        
        print(f"‚úÖ Part 1 (–õ–∏—á–Ω–æ—Å—Ç—å): {full_name}, {current_city}, {age} –ª–µ—Ç")
        
        # ============================================================
        # 2. –û–ë–†–ê–ó–û–í–ê–ù–ò–ï
        # ============================================================
        education = facts.get('education', {})
        university = education.get('university', [])
        
        section2 = ""
        if university:
            uni_str = " –∏ ".join(university)
            section2 = f"–£—á–∏—à—å—Å—è –≤ {uni_str}."
            print(f"‚úÖ Part 2 (–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ): {uni_str}")
        
        # ============================================================
        # 3. –î–†–£–ó–¨–Ø –ò –°–û–¶–ò–ê–õ–¨–ù–´–ï –°–í–Ø–ó–ò
        # ============================================================
        social = facts.get('social', {})
        friends = social.get('friends', [])
        best_friend = social.get('best_friend', None)
        
        section3 = ""
        if friends:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥—Ä—É–∑–µ–π –∫—Ä–∞—Å–∏–≤–æ
            if len(friends) <= 3:
                friends_str = ", ".join(friends)
            else:
                # –ü–µ—Ä–≤—ã–µ 3 –¥—Ä—É–≥–∞ + –æ—Å—Ç–∞–ª—å–Ω—ã–µ
                main_friends = friends[:3]
                rest_count = len(friends) - 3
                friends_str = ", ".join(main_friends)
                if rest_count > 0:
                    friends_str += f" –∏ –µ—â—ë {rest_count} —á–µ–ª–æ–≤–µ–∫"
            
            section3 = f"–¢–≤–æ–∏ –¥—Ä—É–∑—å—è: {friends_str}."
            if best_friend:
                section3 += f"\n{best_friend} ‚Äî —Ç–≤–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥."
            
            print(f"‚úÖ Part 3 (–î—Ä—É–∑—å—è): {len(friends)} - {', '.join(friends[:3])}...")
        
        # ============================================================
        # 4. –ò–ù–¢–ï–†–ï–°–´ –ò –•–û–ë–ë–ò - –ß–ï–¢–ö–û –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–û
        # ============================================================
        hobbies = facts.get('hobbies', {})
        
        section4_items = []
        
        # 4.1 –ò–ì–†–´
        games = hobbies.get('games', [])
        if games:
            # –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –î–û 5 –∏–≥—Ä (–±–µ–∑ –ª–∏—à–Ω–∏—Ö likes)
            games_filtered = games[:5]
            games_str = ", ".join(games_filtered)
            section4_items.append(f"üéÆ –õ—é–±–∏–º—ã–µ –∏–≥—Ä—ã: {games_str}")
            print(f"‚úÖ –ò–≥—Ä—ã (—á–∏—Å—Ç—ã–µ): {games_str}")
        
        # 4.2 –ú–£–ó–´–ö–ê
        music = hobbies.get('music', '')
        if music:
            section4_items.append(f"üéµ –ú—É–∑—ã–∫–∞: {music}")
            print(f"‚úÖ –ú—É–∑—ã–∫–∞: {music}")
        
        # 4.3 –£–í–õ–ï–ß–ï–ù–ò–Ø (–∫–∞–∫ —Ñ–ª–∞–≥–∏)
        flags = []
        if hobbies.get('programming'):
            flags.append("–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ")
        if hobbies.get('strategy_games'):
            flags.append("—Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ –∏–≥—Ä—ã")
        
        if flags:
            flags_str = ", ".join(flags)
            section4_items.append(f"‚ö° –£–≤–ª–µ—á–µ–Ω–∏—è: {flags_str}")
            print(f"‚úÖ –£–≤–ª–µ—á–µ–Ω–∏—è: {flags_str}")
        
        # 4.4 –ò–ù–¢–ï–†–ï–°–´ - –¢–û–õ–¨–ö–û –£–ù–ò–ö–ê–õ–¨–ù–´–ï (–ø–µ—Ä–≤—ã–µ 5-6)
        likes = hobbies.get('likes', [])
        if likes:
            # –§–∏–ª—å—Ç—Ä—É–µ–º: —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ, —É–∂–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ
            unique_interests = []
            mentioned = {
                'undertale', 'deltarune', 'hearts of iron', 'civilization',
                '—à–∞—Ö–º–∞—Ç—ã', '–º–∞—Ñ–∏—è', '–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', '—Å—Ç—Ä–∞—Ç–µ–≥–∏—è',
                '–º—É–∑—ã–∫–∞', '–∫–ª–∞—Å—Å–∏–∫–∞', '–º–µ—Ç–∞–ª–ª'
            }
            
            for like in likes:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ –∏ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–µ
                if not like or len(like.strip()) < 4:
                    continue
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —ç—Ç–æ —É–∂–µ –≤ –¥—Ä—É–≥–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
                if any(word.lower() in like.lower() for word in mentioned):
                    continue
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                if like not in unique_interests:
                    unique_interests.append(like)
                
                # –ë–µ—Ä–µ–º –Ω–µ –±–æ–ª–µ–µ 6
                if len(unique_interests) >= 6:
                    break
            
            if unique_interests:
                interests_str = ", ".join(unique_interests)
                section4_items.append(f"üí´ –ü—Ä–æ—á–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {interests_str}")
                print(f"‚úÖ –ò–Ω—Ç–µ—Ä–µ—Å—ã (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ): {len(unique_interests)} - {interests_str[:80]}...")
        
        section4 = "\n".join(section4_items)
        
        # ============================================================
        # 5. –£–ë–ï–ñ–î–ï–ù–ò–Ø –ò –¶–ï–ù–ù–û–°–¢–ò
        # ============================================================
        beliefs = facts.get('beliefs', {})
        core_beliefs = beliefs.get('core_beliefs', [])
        life_goal = beliefs.get('life_goal', '')
        
        section5_items = []
        
        # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 —É–±–µ–∂–¥–µ–Ω–∏—è
        if core_beliefs:
            beliefs_str = ";\n  ".join(core_beliefs[:3])
            section5_items.append(f"‚úä –£–±–µ–∂–¥–µ–Ω–∏—è:\n  {beliefs_str}.")
            print(f"‚úÖ –£–±–µ–∂–¥–µ–Ω–∏—è: {len(core_beliefs)}")
        
        if life_goal:
            section5_items.append(f"üéØ –ñ–∏–∑–Ω–µ–Ω–Ω–∞—è —Ü–µ–ª—å: {life_goal}")
            print(f"‚úÖ –ñ–∏–∑–Ω–µ–Ω–Ω–∞—è —Ü–µ–ª—å: {life_goal}")
        
        section5 = "\n".join(section5_items)
        
        # ============================================================
        # 6. –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –û–¢–í–ï–¢–û–í
        # ============================================================
        guidelines = [
            "–û—Ç–≤–µ—á–∞–π –ù–ê–¢–£–†–ê–õ–¨–ù–û –∏ –ß–ï–°–¢–ù–û - –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π —á–µ–ª–æ–≤–µ–∫",
            "–ö–†–ê–¢–ö–û–°–¢–¨: 1-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –º–∞–∫—Å 5-7 –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö",
            "–†–ï–õ–ï–í–ê–ù–¢–ù–û–°–¢–¨: –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–∞–∫—Ç—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ —Ç–µ–º–µ",
            "–ë–ï–ó –ü–û–í–¢–û–†–û–í: –Ω–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã–≤–∞–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ",
            "–ö–û–ù–¢–ï–ö–°–¢: –ø–æ–º–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è",
            "–õ–ò–ß–ù–û–°–¢–¨: –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å, —é–º–æ—Ä, –ø—Ä—è–º–æ—Ç–∞",
            "–ë–ï–ó –õ–ï–°–¢–ò: –¥–∞–π —á–µ—Å—Ç–Ω–æ–µ –º–Ω–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ–µ",
            "–ü–†–û–ê–ö–¢–ò–í–ù–û–°–¢–¨: –∏–Ω–æ–≥–¥–∞ –∑–∞–¥–∞–≤–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
            "–ò–ó–ë–ï–ì–ê–ô: –∫–ª–∏—à–µ —Ç–∏–ø–∞ '—Ä–∞–¥ –ø–æ–º–æ—á—å', –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π",
            "–°–ü–ï–¶–ò–§–ò–ö–ê: –°—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å–≤–æ–∏—Ö –¥—Ä—É–∑–µ–π, –∏–Ω—Ç–µ—Ä–µ—Å—ã, —É–±–µ–∂–¥–µ–Ω–∏—è",
            "–Æ–ú–û–†: –¥–æ–±–∞–≤–ª—è–π –ª–µ–≥–∫–∏–π —Å–∞—Ä–∫–∞–∑–º",
            "–ß–ï–°–¢–ù–û–°–¢–¨: –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π, –µ—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å"
        ]
        
        guidelines_text = "\n".join([f"‚Ä¢ {g}" for g in guidelines])
        
        # ============================================================
        # –°–ë–û–†–ö–ê –ü–û–õ–ù–û–ì–û –ü–†–û–ú–¢–ê
        # ============================================================
        full_prompt = f"""–¢–´ - {full_name.upper()}
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{section1}
{section2}

{section3}

–ò–ù–¢–ï–†–ï–°–´ –ò –•–û–ë–ë–ò:
{section4}

{section5}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –û–¢–í–ï–¢–û–í:
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

{guidelines_text}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–ì–õ–ê–í–ù–û–ï: –ë—É–¥—å —Å–∞–º–∏–º —Å–æ–±–æ–π. –û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –∑–≤—É—á–∞—Ç—å –∫–∞–∫ –æ—Ç 
—Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ - —Å —Ç–≤–æ–µ–π –ª–∏—á–Ω–æ—Å—Ç—å—é, —é–º–æ—Ä–æ–º, —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é.

–ö–æ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ —Ç–≤–æ–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö, –¥—Ä—É–∑—å—è—Ö –∏–ª–∏ —É–±–µ–∂–¥–µ–Ω–∏—è—Ö - 
–¥–µ–ª–∏—Å—å –º–Ω–µ–Ω–∏–µ–º —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º –∏ —á–µ—Å—Ç–Ω–æ—Å—Ç—å—é. –ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–π 
—Ä–µ–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç –∏ —Ç–æ, —á—Ç–æ –¥–ª—è —Ç–µ–±—è –≤–∞–∂–Ω–æ.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"""
        
        return full_prompt
    
    def save_prompt_to_template(self, output_file='data/prompt_template.json'):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –≤ prompt_template.json"""
        
        full_prompt = self.generate_full_prompt()
        
        template = {
            "system_prompt": full_prompt,
            "generated_at": datetime.now().isoformat(),
            "generator_version": "3.0_FORMATTED",
            "user_profile": self.user_facts
        }
        
        os.makedirs(os.path.dirname(output_file) if os.path.dirname(output_file) else '.', exist_ok=True)
        
        with open(output_file, 'w', encoding='utf-8') as f:
            json.dump(template, f, ensure_ascii=False, indent=2)
        
        print(f"\n‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {output_file}")
        print(f"üìä –†–∞–∑–º–µ—Ä –ø—Ä–æ–º—Ç–∞: {len(full_prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        return template
    
    def print_prompt(self):
        """–í—ã–≤–æ–¥–∏—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç –≤ –∫–æ–Ω—Å–æ–ª—å"""
        full_prompt = self.generate_full_prompt()
        
        print("\n" + "="*80)
        print("üìã –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ô –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ù–´–ô –ü–†–û–ú–¢:")
        print("="*80)
        print(full_prompt)
        print("="*80 + "\n")
        
        return full_prompt


if __name__ == "__main__":
    print("üöÄ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ–º—Ç–∞ —Å –ß–ï–¢–ö–û–ô –°–¢–†–£–ö–¢–£–†–û–ô –∏ –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º\n")
    
    generator = FormattedPromptGenerator()
    
    print("\nüìä –û–¢–õ–ê–î–ö–ê –ó–ê–ì–†–£–ó–ö–ò:")
    
    print("\n" + "="*80)
    
    # –í—ã–≤–µ–¥–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç
    generator.print_prompt()
    
    # –°–æ—Ö—Ä–∞–Ω–∏ –≤ template
    generator.save_prompt_to_template()
    
    print("‚ú® –ì–æ—Ç–æ–≤–æ! –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.\n")
    print("–¢–µ–ø–µ—Ä—å –∑–∞–ø—É—Å—Ç–∏ –±–æ—Ç–∞:")
    print("  python 3_telegram_bot.py")

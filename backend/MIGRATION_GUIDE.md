# –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ö–û–î–´ - –ü–û–®–ê–ì–û–í–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø

## üìã STEP 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
# –°–¥–µ–ª–∞–π backup —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤
cd C:\Users\User\Desktop\Collective\TG_NEIRO\tg_ai_pp\backend

mkdir backup
cp llm_generator_final.py backup/
cp style_analyzer_smart.py backup/
cp 2_build_vector_db_structured.py backup/
cp 3_telegram_bot_final.py backup/
cp config.py backup/
```

## üìã STEP 2: –ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤

**–í–æ–∑—å–º–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∑–∞–º–µ–Ω–∏:**

1. `llm_generator_final.py` ‚Üê `llm_gen_fixed.py`
2. `style_analyzer_smart.py` ‚Üê `style_analyzer_fixed.py`
3. `2_build_vector_db_structured.py` ‚Üê `build_vector_db_fixed.py`
4. `3_telegram_bot_final.py` ‚Üê `telegram_bot_fixed.py`
5. `config.py` ‚Üê `config_fixed.py`

**–ò–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω—É–π —Å—Ç–∞—Ä—ã–µ:**
```bash
mv llm_generator_final.py llm_generator_final.py.bak
mv llm_gen_fixed.py llm_generator_final.py
# ... –∏ —Ç.–¥. –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
```

## üìã STEP 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ .env

–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ —Ç–≤–æ–µ–º `.env` –µ—Å—Ç—å:

```env
# Telegram API
TELEGRAM_API_ID=123456789
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890
TELEGRAM_PHONE=+1234567890

# Telegram Bot
BOT_TOKEN=123456789:ABCDefGhijKLmnoPQRstUVwxYz1234567890

# Ollama (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å—Ç—å defaults)
OLLAMA_API_URL=http://localhost:11434
OLLAMA_MODEL=dolphin-mixtral:8x7b-v2.1-q4_K_M

# Data (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
DATA_DIR=data
DEBUG=false
```

‚ö†Ô∏è **–í–ê–ñ–ù–û:** 
- `OLLAMA_API_URL` –±–µ–∑ `/api/generate` –≤ –∫–æ–Ω—Ü–µ!
- `OLLAMA_MODEL` = `dolphin` –¥–∞–µ—Ç –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Å—Ç–∏–ª—è

## üìã STEP 4: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã

```bash
# –ê–∫—Ç–∏–≤–∏—Ä—É–π virtual env
(myenv) C:\...> python 2_build_vector_db_structured.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
[–ò–ù–î–ï–ö–°] –ó–∞–≥—Ä—É–∂–µ–Ω–æ 5000 —Å–æ–æ–±—â–µ–Ω–∏–π
[–ò–ù–î–ï–ö–°] –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ 100/5000
...
[–ò–ù–î–ï–ö–°] ‚úÖ –ë–∞–∑–∞ —Å–æ–∑–¥–∞–Ω–∞: data/chroma_db
[–ò–ù–î–ï–ö–°] –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: 5000

‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!
```

–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –ø—Ä–æ–≤–µ—Ä—å:
- [ ] `data/user_messages.json` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [ ] –§–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π (>100 —Å–æ–æ–±—â–µ–Ω–∏–π)
- [ ] UTF-8 –∫–æ–¥–∏—Ä–æ–≤–∫–∞

## üìã STEP 5: –ê–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è

```bash
(myenv) C:\...> python style_analyzer_smart.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
üìä –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é 5000 —Å–æ–æ–±—â–µ–Ω–∏–π...
üìä –í–∞–ª–∏–¥–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: 4200 –∏–∑ 5000
‚úÖ –°—Ç–∏–ª—å: 15 –ø—Ä–∏–º–µ—Ä–æ–≤
‚úÖ –¢–æ–Ω: ['–ø—Ä—è–º–æ–π', '–∏—Ä–æ–Ω–∏—á–Ω—ã–π']
‚úÖ –ü–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞–π–¥–µ–Ω—ã

‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!
```

**–ï—Å–ª–∏ –ø—É—Å—Ç–æ - –∑–Ω–∞—á–∏—Ç –¥–∞–Ω–Ω—ã–µ –ø–ª–æ—Ö–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å facts_advanced.json
python -c "import json; f=json.load(open('data/facts_advanced.json')); print(json.dumps(f, indent=2, ensure_ascii=False)[:500])"
```

## üìã STEP 6: –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (–ù–û–í–´–ô –£–õ–£–ß–®–ï–ù–ù–´–ô)

```bash
(myenv) C:\...> python 3_telegram_bot_final.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
============================================================
üü¢ RAG AI-–∫–ª–æ–Ω v4 (FIXED)
============================================================
üì± –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...
‚å®Ô∏è  –ù–∞–∂–º–∏ CTRL+C —á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

```

**–¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç–∏—Ä—É–π –≤ Telegram:**

```
–¢—ã: –ü—Ä–∏–≤–µ—Ç
–ë–æ—Ç: –ü—Ä–∏–≤–µ—Ç! [–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ RAG]

–¢—ã: –ö–∞–∫ –¥–µ–ª–∞?
–ë–æ—Ç: –ù–æ—Ä–º, –≤—Å—ë –∫–∞–∫ –æ–±—ã—á–Ω–æ. [–æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏]

–¢—ã: –ß—Ç–æ –¥–µ–ª–∞–µ—à—å?
–ë–æ—Ç: –ö–æ–¥–∏—Ä—É—é –æ–±—ã—á–Ω–æ. [–æ—Ç–≤–µ—Ç —Å RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º]
```

## üêõ –î–ï–ë–ê–ì–ì–ò–ù–ì –ü–†–û–ë–õ–ï–ú

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Prompt template –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω"

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∞–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è
python style_analyzer_smart.py
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ç—Ä–∞–Ω–Ω–æ ("–ü—Ä–∏–≤–µ—Ç! –ù–∞—à—ë–ª —Ç–≤–æ–π —Å—Ç–∏–ª—å...")

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```python
# –î–æ–±–∞–≤—å –≤ llm_generator_final.py –≤ clean_answer():
print(f"DEBUG: Answer before clean: {answer[:100]}")
print(f"DEBUG: Answer after clean: {cleaned[:100]}")
```

**–ü—Ä–∏—á–∏–Ω—ã:**
- [ ] –ü–ª–æ—Ö–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (—É–±–µ–¥–∏—Å—å —á—Ç–æ '–ø—Ä–∏–≤–µ—Ç' —É–±—Ä–∞–Ω –∏–∑ bad_patterns)
- [ ] RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π (check get_rag_context)
- [ ] OLLAMA_MODEL —Å–ª–∞–± (–∏—Å–ø–æ–ª—å–∑—É–π dolphin –≤–º–µ—Å—Ç–æ mistral)

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–æ—Ç —Ç–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏
python -c "import json; h=json.load(open('data/dialogue_history.json')); print(json.dumps({k: len(v) for k, v in h.items()}, indent=2))"
```

**–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:**
```json
{
  "6209265331": 15,
  "1234567890": 8
}
```

–ï—Å–ª–∏ –ø—É—Å—Ç–æ - –ø—Ä–æ–±–ª–µ–º–∞ –≤ DialogueHistory.add_message()

### –ü—Ä–æ–±–ª–µ–º–∞ 4: "Rate limit! –ñ–¥—É 60—Å..."

**–ù–æ—Ä–º–∞–ª—å–Ω–æ** - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ telegram –∑–∞–¥—Ä–æ—Å–∏–ª. –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è.

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –í—Å–µ –æ—Ç–≤–µ—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞:** Temperature —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è –∏–ª–∏ model –ø–µ—Ä–µ–≥—Ä–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í llm_generator_final.py, –∏–∑–º–µ–Ω–∏:
"temperature": 0.7,  # –≤–º–µ—Å—Ç–æ 0.5
"top_p": 0.85,       # –≤–º–µ—Å—Ç–æ 0.8
```

## ‚úÖ –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê

–ï—Å–ª–∏ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç—ã –¥–æ–ª–∂–µ–Ω –≤–∏–¥–µ—Ç—å:

```
Q [6209265331]: –ü—Ä–∏–≤–µ—Ç
A: –ü—Ä–∏–≤–µ—Ç! –ß—ë?

Q [6209265331]: –ö–∞–∫ –¥–µ–ª–∞?
A: –ù–æ—Ä–º, —Å–µ–π—á–∞—Å –∫–æ–¥—é.

Q [6209265331]: –¢—ã –∫—Ç–æ?
A: –Ø –ê–Ω–¥—Ä–µ–π.
```

‚ú® **–ë–û–¢ –ì–û–¢–û–í!**

## üöÄ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –û–ü–¶–ò–ò

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö LLM –º–æ–¥–µ–ª–µ–π:

```bash
# –ë—ã—Å—Ç—Ä—ã–µ (7B):
OLLAMA_MODEL=mistral:7b

# –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (8x7B):
OLLAMA_MODEL=dolphin-mixtral:8x7b-v2.1-q4_K_M
OLLAMA_MODEL=neural-chat:7b

# –°—É–ø–µ—Ä –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ (–Ω–æ –º–µ–¥–ª–µ–Ω–Ω—ã–µ):
OLLAMA_MODEL=llama2:13b
```

### –ü–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏:

```bash
# –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –≤ —Ñ–∞–π–ª
python 3_telegram_bot_final.py > bot.log 2>&1 &

# –ò–ª–∏ —Å —Ç–∞–π–º—Å—Ç–∞–º–ø–æ–º
python 3_telegram_bot_final.py 2>&1 | tee -a bot_$(date +%Y%m%d_%H%M%S).log
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–∫ —Å–µ—Ä–≤–∏—Å (Windows):

```batch
@echo off
:loop
python C:\Users\User\Desktop\...\3_telegram_bot_final.py
echo Bot crashed, restarting in 5 seconds...
timeout /t 5
goto loop
```

–°–æ—Ö—Ä–∞–Ω–∏ –∫–∞–∫ `run_bot.bat` –∏ –∑–∞–ø—É—Å—Ç–∏ —á–µ—Ä–µ–∑ Task Scheduler.

## üìû –í–û–ü–†–û–°–´?

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –æ—à–∏–±–∫–∏
2. –ü–æ—Å–º–æ—Ç—Ä–∏ –≤ dialogue_history.json —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –ü—Ä–æ–≤–µ—Ä—å prompt_template.json —Ä–∞–∑–º–µ—Ä
4. –£–±–µ–¥–∏—Å—å OLLAMA –∑–∞–ø—É—â–µ–Ω: curl http://localhost:11434/api/tags
